<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VslicR5 – FNF Character + Chart Preview</title>

<style>
* { box-sizing:border-box; user-select:none; -webkit-user-select:none; }
body { margin:0; padding:10px; background:#111; color:#eee; font-family:monospace; }
h3 { margin:4px 0; text-align:center; color:#0f0; }

.main { display:flex; gap:10px; }
.left { width:320px; display:flex; flex-direction:column; gap:8px; }
.right { flex:1; display:flex; flex-direction:column; gap:10px; }

.upload { background:#1e1e1e; border:1px solid #444; padding:6px; }
label { display:block; background:#222; border:1px solid #555; padding:8px; text-align:center; cursor:pointer; margin-bottom:5px; }

canvas { background:#000; border:1px solid #444; image-rendering:pixelated; }
.char-row { display:flex; gap:10px; }
.char-box { flex:1; text-align:center; }

.controls { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
button { background:#222; border:1px solid #555; color:#fff; width:42px; height:42px; }
button:active { background:#444; }

textarea { width:100%; height:140px; background:#1e1e1e; color:#0f0; border:1px solid #444; font-size:11px; }
#timeLabel { text-align:center; font-size:12px; }

@media (max-width:800px){
  .main { flex-direction:column; }
  .left { width:100%; }
}
</style>
</head>

<body>

<h3>VslicR5 – FNF Character + Chart Preview</h3>

<div class="main">

<div class="left">
  <div class="upload">
    <strong>PLAYER</strong>
    <label>Player XML<input hidden type="file" accept=".xml" onchange="loadXML(this,'player')"></label>
    <label>Player Image<input hidden type="file" accept=".png,.jpg,.webp" onchange="loadImage(this,'player')"></label>
    <label>Player JSON<input hidden type="file" accept=".json" onchange="loadCharJSON(this,'player')"></label>

    <strong>OPPONENT</strong>
    <label>Opponent XML<input hidden type="file" accept=".xml" onchange="loadXML(this,'opponent')"></label>
    <label>Opponent Image<input hidden type="file" accept=".png,.jpg,.webp" onchange="loadImage(this,'opponent')"></label>
    <label>Opponent JSON<input hidden type="file" accept=".json" onchange="loadCharJSON(this,'opponent')"></label>

    <strong>CHART</strong>
    <label>Chart JSON<input hidden type="file" accept=".json" onchange="loadChart(this)"></label>
    <label>Music (any audio)<input hidden type="file" accept="audio/*" onchange="loadAudio(this)"></label>
  </div>

  <textarea id="log" placeholder="log..."></textarea>
</div>

<div class="right">
  <div class="char-row">
    <div class="char-box">
      <h3>OPPONENT</h3>
      <canvas id="oppCanvas" width="300" height="300"></canvas>
    </div>
    <div class="char-box">
      <h3>PLAYER</h3>
      <canvas id="plrCanvas" width="300" height="300"></canvas>
    </div>
  </div>

  <div id="timeLabel">0 ms - 0 ms</div>

  <div class="controls">
    <button onclick="forceAnim('idle')">I</button>
    <button onclick="forceAnim('singLEFT')">←</button>
    <button onclick="forceAnim('singDOWN')">↓</button>
    <button onclick="forceAnim('singUP')">↑</button>
    <button onclick="forceAnim('singRIGHT')">→</button>
    <button onclick="startPlayback()">▶</button>
    <button onclick="stopPlayback()">■</button>
  </div>
</div>
</div>

<audio id="audio"></audio>

<script>
/* ---------------- STATE ---------------- */
const chars = {
  player: { image:null, atlas:{}, anims:{}, cur:'idle', frame:0, fps:24 },
  opponent:{ image:null, atlas:{}, anims:{}, cur:'idle', frame:0, fps:24 }
};

let chart = null;
let playing = false;

/* ---------------- LOG ---------------- */
const logBox = document.getElementById("log");
const log = t => logBox.value += t + "\n";

/* ---------------- LOADERS ---------------- */
function loadXML(input, who){
  const r = new FileReader();
  r.onload = () => {
    const xml = new DOMParser().parseFromString(r.result,"text/xml");
    chars[who].atlas = {};
    xml.querySelectorAll("SubTexture").forEach(st=>{
      const name = st.getAttribute("name");
      (chars[who].atlas[name] ??= []).push({
        x:+st.getAttribute("x"),
        y:+st.getAttribute("y"),
        w:+st.getAttribute("width"),
        h:+st.getAttribute("height")
      });
    });
    log(`${who} XML loaded`);
  };
  r.readAsText(input.files[0]);
}

function loadImage(input, who){
  const img = new Image();
  img.onload = ()=>{ chars[who].image = img; log(`${who} image loaded`); };
  img.src = URL.createObjectURL(input.files[0]);
}

function loadCharJSON(input, who){
  const r = new FileReader();
  r.onload = ()=>{
    const data = JSON.parse(r.result);
    chars[who].anims = {};
    data.animations.forEach(a=>{
      chars[who].anims[a.name] = a;
    });
    log(`${who} character JSON loaded`);
  };
  r.readAsText(input.files[0]);
}

function loadChart(input){
  const r = new FileReader();
  r.onload = ()=>{ chart = JSON.parse(r.result); log("chart loaded"); };
  r.readAsText(input.files[0]);
}

function loadAudio(input){
  const a = audio;
  a.src = URL.createObjectURL(input.files[0]);
  a.onloadedmetadata = ()=>{
    timeLabel.textContent = `0 ms - ${Math.floor(a.duration*1000)} ms`;
  };
  a.onerror = ()=> log("Audio format not supported by browser");
  a.onended = stopPlayback;
}

/* ---------------- DRAW ---------------- */
function drawChar(ctx, c){
  const anim = c.anims[c.cur];
  if(!c.image || !anim) return;

  const frames = Object.keys(c.atlas)
    .filter(k=>k.startsWith(anim.prefix))
    .sort();

  if(!frames.length) return;

  const f = c.atlas[frames[c.frame % frames.length]][0];
  ctx.clearRect(0,0,300,300);
  ctx.drawImage(c.image,f.x,f.y,f.w,f.h,50,50,f.w*0.5,f.h*0.5);
}

/* ---------------- LOOP ---------------- */
function loop(){
  drawChar(plrCanvas.getContext("2d"), chars.player);
  drawChar(oppCanvas.getContext("2d"), chars.opponent);

  if(playing && chart){
    const t = audio.currentTime * 1000;
    chart.notes?.normal?.forEach(n=>{
      if(Math.abs(n.t - t) < 35){
        const who = n.l < 4 ? chars.player : chars.opponent;
        const dir = ["LEFT","DOWN","UP","RIGHT"][n.l % 4];
        setCharAnim(who, "sing"+dir);
      }
    });
  }

  Object.values(chars).forEach(c=>c.frame++);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------------- ANIM CONTROL ---------------- */
function setCharAnim(c, a){
  if(c.cur !== a){
    c.cur = a;
    c.frame = 0;
  }
}

function forceAnim(a){
  setCharAnim(chars.player,a);
  setCharAnim(chars.opponent,a);
}

function startPlayback(){
  if(!chart || !audio.src) return;
  audio.currentTime = 0;
  audio.play();
  playing = true;
}

function stopPlayback(){
  playing = false;
  audio.pause();
  forceAnim("idle");
}
</script>

</body>
</html>
