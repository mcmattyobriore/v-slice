<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XML SpriteSheet ‚Üí Individual Frames ZIP</title>

<style>
body {
  margin:0;
  padding:10px;
  background:#111;
  color:#0f0;
  font-family:monospace;
}
h3 { text-align:center; margin:6px 0; }
.panel {
  max-width:520px;
  margin:auto;
  background:#1b1b1b;
  border:1px solid #444;
  padding:10px;
}
label {
  display:block;
  background:#222;
  border:1px solid #555;
  padding:8px;
  margin-bottom:6px;
  text-align:center;
  cursor:pointer;
}
canvas {
  display:block;
  margin:10px auto;
  background:#000;
  border:1px solid #555;
  image-rendering:pixelated;
}
.controls { display:flex; justify-content:center; gap:6px; flex-wrap:wrap; }
button { background:#222; border:1px solid #555; color:#fff; padding:6px 10px; }
</style>
</head>

<body>

<h3>XML SpriteSheet ‚Üí Frames ZIP</h3>

<div class="panel">
  <label>Load XML<input hidden type="file" accept=".xml" onchange="loadXML(this)"></label>
  <label>Load SpriteSheet<input hidden type="file" accept="image/*" onchange="loadImage(this)"></label>

  <canvas id="canvas" width="600" height="600"></canvas>

  <div class="controls">
    <button onclick="play()">‚ñ∂</button>
    <button onclick="pause()">‚è∏</button>
    <button onclick="step(-1)">‚üµ</button>
    <button onclick="step(1)">‚ü∂</button>
    <button onclick="exportFrames()">üíæ Export Frames ZIP</button>
  </div>

  <div id="info">Frames: 0</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let image = null;
let frames = [];
let frameIndex = 0;
let playing = false;

/* ---------- XML & Image Load ---------- */
function loadXML(input){
  const reader = new FileReader();
  reader.onload = () => {
    const xml = new DOMParser().parseFromString(reader.result,"text/xml");
    frames = [];
    xml.querySelectorAll("SubTexture").forEach(st=>{
      frames.push({
        name: st.getAttribute("name"),
        x:+st.getAttribute("x"),
        y:+st.getAttribute("y"),
        w:+st.getAttribute("width"),
        h:+st.getAttribute("height"),
        fx:+st.getAttribute("frameX"),
        fy:+st.getAttribute("frameY"),
        fw:+st.getAttribute("frameWidth"),
        fh:+st.getAttribute("frameHeight")
      });
    });
    frameIndex=0;
    updateInfo();
    draw();
  };
  reader.readAsText(input.files[0]);
}

function loadImage(input){
  image = new Image();
  image.onload = () => draw();
  image.src = URL.createObjectURL(input.files[0]);
}

/* ---------- DRAW ---------- */
function draw(){
  if(!image || !frames.length) return;
  const f = frames[frameIndex];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx = canvas.width/2 - f.fw/2;
  const cy = canvas.height/2 - f.fh/2;
  ctx.drawImage(
    image,
    f.x, f.y, f.w, f.h,
    cx+f.fx, cy+f.fy,
    f.w, f.h
  );
}

/* ---------- LOOP ---------- */
function loop(time){
  if(playing){
    frameIndex = (frameIndex+1)%frames.length;
    draw();
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------- CONTROLS ---------- */
function play(){ playing = true; }
function pause(){ playing = false; }
function step(dir){ playing=false; frameIndex=(frameIndex+dir+frames.length)%frames.length; draw(); }
function updateInfo(){ document.getElementById("info").textContent = `Frames: ${frames.length}`; }

/* ---------- EXPORT INDIVIDUAL FRAMES ---------- */
function exportFrames(){
  if(!image || !frames.length) return alert("Load XML + image first!");

  const zip = new JSZip();
  const tmpCanvas = document.createElement("canvas");
  const tmpCtx = tmpCanvas.getContext("2d");

  frames.forEach((f,i)=>{
    tmpCanvas.width = f.fw;
    tmpCanvas.height = f.fh;
    tmpCtx.clearRect(0,0,tmpCanvas.width,tmpCanvas.height);
    tmpCtx.drawImage(image, f.x, f.y, f.w, f.h, -f.fx, -f.fy, f.w, f.h);

    // Save frame to PNG blob
    tmpCanvas.toBlob(blob=>{
      const name = i.toString().padStart(4,"0") + ".png";
      zip.file(name, blob);

      // If last frame, generate ZIP
      if(i === frames.length-1){
        zip.generateAsync({type:"blob"}).then(content=>{
          const a = document.createElement("a");
          a.href = URL.createObjectURL(content);
          a.download = "frames.zip";
          a.click();
          URL.revokeObjectURL(a.href);
        });
      }
    }, "image/png");
  });
}
</script>

</body>
</html>
