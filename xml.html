<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VslicR5 – Character Preview</title>

<style>
* {
  box-sizing: border-box;
  user-select: none;
  -webkit-user-select: none;
}

body {
  margin: 0;
  padding: 10px;
  background: #111;
  color: #eee;
  font-family: monospace;
}

h3 {
  margin: 4px 0;
  text-align: center;
  color: #0f0;
}

.main {
  display: flex;
  gap: 10px;
}

.left {
  width: 300px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.right {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.upload {
  background: #1e1e1e;
  border: 1px solid #444;
  padding: 6px;
}

label {
  display: block;
  background: #222;
  border: 1px solid #555;
  padding: 8px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 5px;
}

canvas {
  background: #000;
  border: 1px solid #444;
  image-rendering: pixelated;
}

.char-row {
  display: flex;
  gap: 10px;
  justify-content: space-between;
}

.char-box {
  flex: 1;
  text-align: center;
}

.controls {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
}

button {
  background: #222;
  border: 1px solid #555;
  color: #fff;
  width: 42px;
  height: 42px;
  font-size: 16px;
}

button:active {
  background: #444;
}

textarea {
  width: 100%;
  height: 160px;
  background: #1e1e1e;
  color: #0f0;
  border: 1px solid #444;
  font-size: 11px;
}

@media (max-width: 800px) {
  .main { flex-direction: column; }
  .left { width: 100%; }
}
</style>
</head>

<body>

<h3>VslicR5 – Character + Chart Preview</h3>

<div class="main">
  <!-- LEFT -->
  <div class="left">
    <div class="upload">
      <label>
        Upload XML
        <input type="file" accept=".xml" hidden onchange="loadXML(this)">
      </label>

      <label>
        Upload Image / Spritesheet
        <input type="file" accept=".png,.jpg,.webp" hidden onchange="loadImage(this)">
      </label>

      <label>
        Upload GIF (auto-split)
        <input type="file" accept=".gif" hidden onchange="loadGIF(this)">
      </label>

      <label>
        Upload Chart JSON
        <input type="file" accept=".json" hidden onchange="loadChart(this)">
      </label>
    </div>

    <textarea id="log" placeholder="debug log..."></textarea>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="char-row">
      <div class="char-box">
        <h3>OPPONENT</h3>
        <canvas id="oppCanvas" width="300" height="300"></canvas>
      </div>
      <div class="char-box">
        <h3>PLAYER</h3>
        <canvas id="plrCanvas" width="300" height="300"></canvas>
      </div>
    </div>

    <div class="controls">
      <button onclick="playAnim('idle')">I</button>
      <button onclick="playAnim('singLEFT')">←</button>
      <button onclick="playAnim('singDOWN')">↓</button>
      <button onclick="playAnim('singUP')">↑</button>
      <button onclick="playAnim('singRIGHT')">→</button>
      <button onclick="startChart()">▶</button>
      <button onclick="stopChart()">■</button>
    </div>
  </div>
</div>

<script>
/* ------------------ CORE STATE ------------------ */
let atlas = {};
let image = null;
let chart = null;
let playingChart = false;
let chartStart = 0;
let currentAnim = 'idle';
let frameIndex = 0;
let lastFrameTime = 0;

/* ------------------ LOG ------------------ */
function log(t) {
  document.getElementById('log').value += t + "\n";
}

/* ------------------ XML ------------------ */
function loadXML(input) {
  const r = new FileReader();
  r.onload = () => {
    const xml = new DOMParser().parseFromString(r.result, "text/xml");
    atlas = {};
    xml.querySelectorAll("SubTexture").forEach(st => {
      const name = st.getAttribute("name").split(" ")[0];
      if (!atlas[name]) atlas[name] = [];
      atlas[name].push({
        x: +st.getAttribute("x"),
        y: +st.getAttribute("y"),
        w: +st.getAttribute("width"),
        h: +st.getAttribute("height")
      });
    });
    log("XML loaded");
  };
  r.readAsText(input.files[0]);
}

/* ------------------ IMAGE ------------------ */
function loadImage(input) {
  const img = new Image();
  img.onload = () => {
    image = img;
    log("Image loaded");
  };
  img.src = URL.createObjectURL(input.files[0]);
}

/* ------------------ GIF → SPRITESHEET ------------------ */
function loadGIF(input) {
  const gif = document.createElement("img");
  gif.src = URL.createObjectURL(input.files[0]);

  gif.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = gif.width;
    canvas.height = gif.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(gif, 0, 0);
    image = canvas;
    atlas["idle"] = [{ x:0, y:0, w:gif.width, h:gif.height }];
    log("GIF converted to static spritesheet");
  };
}

/* ------------------ CHART ------------------ */
function loadChart(input) {
  const r = new FileReader();
  r.onload = () => {
    chart = JSON.parse(r.result);
    log("Chart loaded");
  };
  r.readAsText(input.files[0]);
}

/* ------------------ ANIMATION ------------------ */
function playAnim(name) {
  currentAnim = name;
  frameIndex = 0;
}

function drawChar(ctx, anim) {
  if (!image || !atlas[anim]) return;
  const frame = atlas[anim][frameIndex % atlas[anim].length];
  ctx.clearRect(0,0,300,300);
  ctx.drawImage(
    image,
    frame.x, frame.y, frame.w, frame.h,
    50, 50, frame.w * 0.5, frame.h * 0.5
  );
}

function loop(ts) {
  if (ts - lastFrameTime > 100) {
    frameIndex++;
    lastFrameTime = ts;
  }

  drawChar(document.getElementById("oppCanvas").getContext("2d"), currentAnim);
  drawChar(document.getElementById("plrCanvas").getContext("2d"), currentAnim);

  if (playingChart && chart) {
    const t = ts - chartStart;
    chart.notes?.normal?.forEach(n => {
      if (Math.abs(n.t - t) < 50) {
        playAnim(n.l < 4 ? "singLEFT" : "singRIGHT");
      }
    });
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);

/* ------------------ CHART PLAYBACK ------------------ */
function startChart() {
  playingChart = true;
  chartStart = performance.now();
}

function stopChart() {
  playingChart = false;
  playAnim("idle");
}
</script>

</body>
</html>
